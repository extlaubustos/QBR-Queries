SELECT
C.TITLE_ADJUSTED,
--C.CONTENT_TYPE,
CASE
WHEN C.CONTENT_TYPE = 'MOVIE' THEN 'MOVIE'
ELSE 'SERIES'
END AS CONTENT_TYPE_AJUSTADO,
C.CONTENT_PROVIDER,
CASE
WHEN C.CONTENT_PROVIDER = 'SONY' THEN 'SONY'
WHEN C.CONTENT_PROVIDER IN ('PARAMOUNT', 'CBS','PARAMOUNTTL','PARAMOUNBR') THEN 'PARAMOUNT'
WHEN C.CONTENT_PROVIDER = 'MPLAYORIGINALS' THEN 'MPLAYORIGINALS'
WHEN C.CONTENT_PROVIDER IN ('NBCUAVOD', 'UNIVERSALPLUS') OR P.CHANNEL_ID IN ('3062aa4b18ff46ed8d59fe6c3f088bc6','167e27fd5bb84dfabde7103648b9a96b','3f1cc2cccea34b9490b00d6ac514e225','63b08af757040aebdb2d23246fcf71a','9e95f70f53e54e3b86850c2d9a7b1df5','24d2994c2807438eb89c817534ed76db','bb853ee1e9264f018031baab6ea1e3d2') THEN 'NBCU'
ELSE C.CONTENT_PROVIDER 
END AS CONTENT_PROVIDER_AJUSTADO,
SAFE_DIVIDE(SUM(IF((P.PLAYBACK_TIME_MILLISECONDS ) >= 20000, P.PLAYBACK_TIME_MILLISECONDS , NULL)), 60000) AS TVM,
COUNT(DISTINCT CASE WHEN (P.PLAYBACK_TIME_MILLISECONDS >= 20000) THEN P.USER_ID ELSE NULL END) AS VIEWERS,
COUNT(DISTINCT (TIMESTAMP(P.DS))) AS DAYS

FROM `meli-bi-data.WHOWNER.BT_MKT_MPLAY_PLAYS`  P
LEFT JOIN `meli-bi-data.WHOWNER.LK_MKT_MPLAY_CATALOGUE` C 
ON P.SIT_SITE_ID = C.SIT_SITE_ID
AND P.CONTENT_ID = C.CONTENT_ID

WHERE P.DS BETWEEN '2025-04-01' AND '2025-05-31'
AND NOT LIVE
GROUP BY 1, 2, 3, 4 --, 5
